<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bootleg Empire</title>
  <!-- Note: Tailwind CSS CDN is used for development. For production, install Tailwind CLI or use PostCSS: https://tailwindcss.com/docs/installation -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background-image: url('https://images.unsplash.com/photo-1591280063464-0a6336e93e43?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
      background-size: cover;
      background-attachment: fixed;
      font-family: 'Times New Roman', Times, serif;
      color: #2c2c2c;
    }
    .dark-theme {
      background-color: #1a1a1a;
      color: #e0e0e0;
    }
    .dark-theme .main-bg {
      background-color: rgba(30, 30, 30, 0.95);
    }
    .dark-theme .tab-bg {
      background-color: rgba(30, 30, 30, 0.9);
    }
    .dark-theme .tooltip {
      background-color: rgba(30, 30, 30, 0.95);
      color: #2c2c2c;
      border: 1px solid #8b5a2b;
    }
    .dark-theme .card {
      background-color: rgba(40, 40, 40, 0.95);
    }
    .light-theme {
      background-color: #f2e2c3;
      color: #2c2c2c;
    }
    .light-theme .main-bg {
      background-color: rgba(242, 226, 195, 0.95);
    }
    .light-theme .tab-bg {
      background-color: rgba(242, 226, 195, 0.9);
    }
    .light-theme .tooltip {
      background-color: rgba(242, 226, 195, 0.95);
      color: #000;
      border: 1px solid #8b5a2b;
    }
    .light-theme .card {
      background-color: rgba(255, 255, 255, 0.95);
    }
    .art-deco {
      font-family: 'Cinzel', serif;
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .card {
      border: 2px solid #8b5a2b;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .card:hover {
      transform: scale(1.02);
      transition: transform 0.2s;
    }
    .tab-button {
      position: relative;
    }
    .tab-button::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background-color: #8b5a2b;
      transition: width 0.3s ease-in-out;
    }
    .tab-button.bg-gray-300::after {
      width: 100%;
    }
    .tooltip {
      display: none;
      position: absolute;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
      z-index: 10;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      min-width: 150px;
      text-align: center;
    }
    .group:not(.opacity-50):hover .tooltip {
      display: block;
    }
    .hide-timestamp .timestamp {
      display: none;
    }
  </style>
</head>
<body class="min-h-screen light-theme">
  <div id="game" class="container mx-auto p-4 max-w-5xl main-bg rounded-lg min-h-screen">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-4xl font-bold text-center art-deco">Bootleg Empire</h1>
      <button id="themeToggle" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Switch to Dark Theme</button>
    </div>
    
    <!-- Dashboard -->
    <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <details open class="card p-4">
        <summary class="text-2xl art-deco cursor-pointer">Player Stats</summary>
        <p><strong>Name:</strong> <span id="playerName">Greenhorn</span></p>
        <p><strong>Rank:</strong> <span id="rank">Greenhorn</span></p>
        <p><strong>Cash:</strong> <span class="text-green-700">$<span id="cash">0</span></span></p>
        <p><strong>Hooch:</strong> <span class="text-amber-800"><span id="hooch">0</span></span></p>
        <p><strong>Bullets:</strong> <span class="text-gray-700"><span id="bullets">0</span></span></p>
        <p><strong>Action Points:</strong> <span id="ap">30000/30000</span></p>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
          <div id="apBar" class="bg-green-600 h-2.5 rounded-full" style="width: 100%"></div>
        </div>
        <p><strong>Health:</strong> <span id="health" class="inline-block">100</span>/100</p>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
          <div id="healthBar" class="bg-red-600 h-2.5 rounded-full" style="width: 100%"></div>
        </div>
        <p><strong>Experience:</strong> <span id="xp">0</span></p>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
          <div id="xpBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        <p><strong>Influence:</strong> <span id="influence">0</span></p>
        <p><strong>Perks:</strong> <span id="perks">None</span></p>
      </details>
      <details open class="card p-4">
        <summary class="text-2xl art-deco cursor-pointer">Inventory</summary>
        <div class="mb-2">
          <button id="sortName" class="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800">Sort by Name</button>
          <button id="sortType" class="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800">Sort by Type</button>
        </div>
        <ul id="inventory" class="list-disc pl-5"></ul>
        <h2 class="text-2xl art-deco mt-4">Equipped Items</h2>
        <p><strong>Weapon:</strong> <span id="equippedWeapon">None</span></p>
        <p><strong>Vehicle:</strong> <span id="equippedVehicle">None</span></p>
        <p><strong>Clothing:</strong> <span id="equippedClothing">None</span></p>
      </details>
    </div>

    <!-- Navigation Tabs -->
    <div class="flex flex-wrap border-b-2 border-gray-700 mb-4 sticky top-0 z-10 tab-bg">
      <button class="tab-button px-4 py-2 font-bold art-deco bg-gray-200 hover:bg-gray-300" data-tab="crimes">Crimes</button>
      <button class="tab-button px-4 py-2 font-bold art-deco bg-gray-200 hover:bg-gray-300" data-tab="shop">Shop</button>
      <button class="tab-button px-4 py-2 font-bold art-deco bg-gray-200 hover:bg-gray-300" data-tab="crew">Crew</button>
      <button class="tab-button px-4 py-2 font-bold art-deco bg-gray-200 hover:bg-gray-300" data-tab="gambling">Gambling</button>
      <button class="tab-button px-4 py-2 font-bold art-deco bg-gray-200 hover:bg-gray-300" data-tab="chat">Chat</button>
      <button class="tab-button px-4 py-2 font-bold art-deco bg-gray-200 hover:bg-gray-300" data-tab="business">Business</button>
    </div>

    <!-- Tab Content -->
    <div id="crimes" class="tab-content hidden">
      <h2 class="text-2xl art-deco mb-4">Available Crimes</h2>
      <div class="mb-4">
        <button class="filter-crime px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-filter="all">All</button>
        <button class="filter-crime px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-filter="tier-1">Tier 1</button>
        <button class="filter-crime px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-filter="tier-2">Tier 2</button>
        <button class="filter-crime px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-filter="tier-3">Tier 3</button>
        <button class="filter-crime px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-filter="ap-based">AP-Based</button>
        <button class="filter-crime px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-filter="cooldown-based">Cooldown-Based</button>
      </div>
      <div id="crimeList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
    <div id="shop" class="tab-content hidden">
      <h2 class="text-2xl art-deco mb-4">Black Market</h2>
      <div class="mb-4">
        <button id="buyHooch" class="group relative px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">
          Buy Hooch ($10–$50)
          <span class="tooltip">Purchase 1 Hooch at a random price between $10 and $50</span>
        </button>
        <button id="sellHooch" class="group relative px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">
          Sell Hooch ($8–$40)
          <span class="tooltip">Sell 1 Hooch at a random price between $8 and $40</span>
        </button>
      </div>
      <div id="shopItems" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
    <div id="crew" class="tab-content hidden">
      <h2 class="text-2xl art-deco mb-4">Crew Management</h2>
      <div id="crewStatus"></div>
      <button id="joinCrew" class="mt-4 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Join a Crew</button>
      <button id="formCrew" class="mt-4 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Form a Crew ($5,000)</button>
    </div>
    <div id="gambling" class="tab-content hidden">
      <h2 class="text-2xl art-deco mb-4">Gambling Den</h2>
      <div class="mb-4">
        <label for="betAmount">Bet Amount ($):</label>
        <input id="betAmount" type="number" min="5" max="100" value="10" class="border p-2">
        <button id="playPoker" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Poker</button>
        <button id="playBlackjack" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Blackjack</button>
        <button id="playKeno" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Keno</button>
        <button id="playHorseRacing" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Horse Racing</button>
        <button id="playRoulette" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Roulette</button>
        <button id="playThreeCardMonte" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Three Card Monte</button>
        <button id="playCraps" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Craps</button>
      </div>
      <p id="gamblingResult" class="text-lg font-bold"></p>
      <h3 class="text-xl art-deco mt-4">Recent Bets</h3>
      <div id="betHistory" class="h-32 overflow-y-auto border p-2"></div>
    </div>
    <div id="chat" class="tab-content hidden">
      <h2 class="text-2xl art-deco mb-4">Speakeasy Chat</h2>
      <div id="chatMessages" class="h-64 overflow-y-auto border p-2 mb-4"></div>
      <input id="chatInput" type="text" class="border p-2 w-full" placeholder="Type your message...">
      <button id="sendChat" class="mt-2 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Send</button>
    </div>
    <div id="business" class="tab-content hidden">
      <h2 class="text-2xl art-deco mb-4">Business Management</h2>
      <div id="businessStatus"></div>
      <button id="buySpeakeasy" class="mt-4 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Buy Speakeasy ($1,000)</button>
      <button id="buyDistillery" class="mt-4 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Buy Distillery ($2,500)</button>
    </div>

    <!-- Event Log -->
    <div class="mt-6 card p-4">
      <h2 class="text-2xl art-deco mb-4">Event Log</h2>
      <div class="mb-2">
        <button id="clearLog" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Clear Log</button>
        <button id="toggleTimestamps" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Toggle Timestamps</button>
      </div>
      <div id="eventLog" class="h-64 overflow-y-auto"></div>
    </div>

    <!-- Quick Action Button (Mobile) -->
    <div class="fixed bottom-4 right-4 md:hidden">
      <button id="quickActionToggle" class="p-4 bg-gray-700 text-white rounded-full hover:bg-gray-800">⚡</button>
      <div id="quickActions" class="hidden absolute bottom-16 right-0 tab-bg p-4 rounded-lg shadow-lg">
        <button id="quickBuyHooch" class="block w-full text-left px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 mb-2">Buy Hooch</button>
        <button id="quickPickpocket" class="block w-full text-left px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">Pickpocket</button>
      </div>
    </div>
  </div>

  <script>
    // Default Player State
    const defaultPlayer = {
      name: "Greenhorn",
      rank: "Greenhorn",
      cash: 0,
      hooch: 0,
      bullets: 0,
      ap: 30000,
      maxAp: 30000,
      health: 100,
      maxHealth: 100,
      xp: 0,
      influence: 0,
      inventory: [],
      equipped: { weapon: null, vehicle: null, clothing: null },
      crew: null,
      businesses: [],
      perks: [],
      cooldowns: {}
    };

    let player = { ...defaultPlayer };
    let currentCrimeFilter = "all";
    let showTimestamps = true;

    const ranks = [
      { name: "Greenhorn", xp: 0, influence: 0 },
      { name: "Soldier", xp: 101, influence: 11 },
      { name: "Caporegime", xp: 501, influence: 51 },
      { name: "Consigliere", xp: 2001, influence: 201 },
      { name: "Underboss", xp: 5001, influence: 501 },
      { name: "Don", xp: 10001, influence: 1001 }
    ];

    const crimes = [
      { name: "Pickpocketing", tier: 1, apCost: 5, cashMin: 5, cashMax: 20, hoochMin: 0, hoochMax: 5, xpMin: 5, xpMax: 10, influenceMin: 0, influenceMax: 1, risk: 0.1, bulletCost: 0, healthCost: 10, requirements: [] },
      { name: "Steal a Car", tier: 1, apCost: 10, cashMin: 100, cashMax: 300, hoochMin: 0, hoochMax: 5, xpMin: 5, xpMax: 15, influenceMin: 1, influenceMax: 3, risk: 0.2, bulletCost: 0, healthCost: 15, requirements: [] },
      { name: "Bootlegging Small Batch", tier: 1, apCost: 10, cashMin: 50, cashMax: 100, hoochMin: 1, hoochMax: 5, xpMin: 10, xpMax: 15, influenceMin: 1, influenceMax: 2, risk: 0.15, bulletCost: 0, healthCost: 10, requirements: ["Moonshine Still", "Liquor Crate"] },
      { name: "Order a Hit", tier: 2, apCost: 0, cooldown: 3600000, cashMin: 200, cashMax: 500, hoochMin: 5, hoochMax: 10, xpMin: 20, xpMax: 30, influenceMin: 10, influenceMax: 20, risk: 0.2, bulletCost: 10, healthCost: 20, requirements: ["Colt .45 Pistol"] },
      { name: "Speakeasy Operation", tier: 2, apCost: 0, cooldown: 3600000, cashMin: 200, cashMax: 500, hoochMin: 5, hoochMax: 10, xpMin: 20, xpMax: 30, influenceMin: 5, influenceMax: 10, risk: 0.2, bulletCost: 0, healthCost: 15, requirements: ["Safehouse", "Liquor Crate", "Liquor Crate", "Liquor Crate"] },
      { name: "Liquor Shipment Hijack", tier: 2, apCost: 0, cooldown: 3600000, cashMin: 300, cashMax: 700, hoochMin: 5, hoochMax: 10, xpMin: 25, xpMax: 40, influenceMin: 10, influenceMax: 15, risk: 0.25, bulletCost: 10, healthCost: 20, requirements: ["Ford Model T", "Colt .45 Pistol"] },
      { name: "Bank Heist", tier: 3, apCost: 0, cooldown: 28800000, cashMin: 2000, cashMax: 5000, hoochMin: 10, hoochMax: 20, xpMin: 50, xpMax: 100, influenceMin: 20, influenceMax: 50, risk: 0.4, bulletCost: 20, healthCost: 30, requirements: ["Crew", "Cadillac", "Tommy Gun"] },
      { name: "Large-Scale Smuggling", tier: 3, apCost: 0, cooldown: 28800000, cashMin: 5000, cashMax: 10000, hoochMin: 20, hoochMax: 50, xpMin: 80, xpMax: 150, influenceMin: 50, influenceMax: 100, risk: 0.5, bulletCost: 20, healthCost: 30, requirements: ["Crew", "Boat", "Bribe Money"] }
    ];

    const shopItems = [
      { name: "Switchblade", cost: 10, hoochCost: 0, type: "Weapon", bulletCost: 1, apCost: 0, bonus: { success: 0.05 }, description: "+5% crime success, uses 1 Bullet/crime" },
      { name: "Colt .45 Pistol", cost: 50, hoochCost: 0, type: "Weapon", bulletCost: 5, apCost: 0, bonus: { success: 0.1 }, description: "+10% crime success, uses 5 Bullets/crime" },
      { name: "Tommy Gun", cost: 200, hoochCost: 0, type: "Weapon", bulletCost: 10, apCost: 0, bonus: { success: 0.2 }, description: "+20% crime success, uses 10 Bullets/crime" },
      { name: "Custom Tommy Gun", cost: 0, hoochCost: 50, type: "Weapon", bulletCost: 10, apCost: 0, bonus: { success: 0.25 }, description: "+25% crime success, uses 10 Bullets/crime" },
      { name: "Ford Model T", cost: 300, hoochCost: 0, type: "Vehicle", bulletCost: 0, apCost: 0, bonus: { getaway: 0.1 }, sellPrice: 150, scrapBullets: 5, description: "+10% getaway success, sell for $150, scrap for 5 Bullets" },
      { name: "Cadillac", cost: 1000, hoochCost: 0, type: "Vehicle", bulletCost: 0, apCost: 0, bonus: { getaway: 0.2, influence: 0.05 }, sellPrice: 500, scrapBullets: 15, description: "+20% getaway success, +5% Influence/crime, sell for $500, scrap for 15 Bullets" },
      { name: "Boat", cost: 2000, hoochCost: 0, type: "Vehicle", bulletCost: 0, apCost: 0, bonus: { success: 0.15 }, sellPrice: 1000, scrapBullets: 20, description: "+15% smuggling success, sell for $1000, scrap for 20 Bullets" },
      { name: "Moonshine Still", cost: 150, hoochCost: 0, type: "Supply", bulletCost: 0, apCost: 0, bonus: { produces: "Liquor Crate" }, description: "Produces 1 Liquor Crate/day" },
      { name: "Liquor Crate", cost: 50, hoochCost: 0, type: "Supply", bulletCost: 0, apCost: 0, bonus: {}, description: "Required for bootlegging and speakeasy crimes" },
      { name: "Bribe Money", cost: 100, hoochCost: 0, type: "Supply", bulletCost: 0, apCost: 0, bonus: { raidReduction: 0.1 }, description: "-10% business raid risk (consumed)" },
      { name: "Fedora and Suit", cost: 75, hoochCost: 0, type: "Clothing", bulletCost: 0, apCost: 0, bonus: { influence: 5 }, description: "+5 Influence/crime" },
      { name: "Coffee", cost: 5, hoochCost: 0, type: "Consumable", bulletCost: 0, apCost: 10, bonus: { apRegen: 2, duration: 3600000 }, description: "+2 AP/min for 1 hour, costs 10 AP" },
      { name: "Whiskey Shot", cost: 10, hoochCost: 0, type: "Consumable", bulletCost: 0, apCost: 10, bonus: { health: 20 }, description: "Restores 20 Health, costs 10 AP" },
      { name: "First Aid Kit", cost: 25, hoochCost: 0, type: "Consumable", bulletCost: 0, apCost: 10, bonus: { health: 100 }, description: "Restores full Health, costs 10 AP" },
      { name: "Safehouse", cost: 500, hoochCost: 0, type: "Property", bulletCost: 0, apCost: 0, bonus: {}, description: "Required for speakeasy crimes" },
      { name: "Fast Talker", cost: 0, hoochCost: 100, type: "Perk", bulletCost: 0, apCost: 0, bonus: { cooldownReduction: 0.1 }, description: "-10% crime cooldowns (permanent)" },
      { name: "Connected", cost: 0, hoochCost: 150, type: "Perk", bulletCost: 0, apCost: 0, bonus: { raidReduction: 0.2 }, description: "-20% business raid risk (permanent)" },
      { name: "Bullets", cost: 1, hoochCost: 0, type: "Resource", bulletCost: 0, apCost: 0, bonus: {}, description: "Used for weapons in crimes and hits" }
    ];

    // Load/Save Player Data
    function loadGame() {
      const saved = localStorage.getItem("bootlegEmpire");
      if (saved) {
        const savedPlayer = JSON.parse(saved);
        player = { ...defaultPlayer, ...savedPlayer, equipped: { ...defaultPlayer.equipped, ...savedPlayer.equipped } };
        if (!savedPlayer.ap || savedPlayer.ap > defaultPlayer.maxAp) {
          player.ap = defaultPlayer.maxAp;
        }
      } else {
        player.ap = defaultPlayer.maxAp;
      }
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        document.body.classList.remove("light-theme");
        document.body.classList.add("dark-theme");
        document.getElementById("themeToggle").textContent = "Switch to Light Theme";
      } else {
        document.body.classList.remove("dark-theme");
        document.body.classList.add("light-theme");
        document.getElementById("themeToggle").textContent = "Switch to Dark Theme";
      }
      updateUI();
    }

    function saveGame() {
      localStorage.setItem("bootlegEmpire", JSON.stringify(player));
    }

    // Update UI
    function updateUI() {
      document.getElementById("playerName").textContent = player.name;
      document.getElementById("rank").textContent = player.rank;
      document.getElementById("cash").textContent = player.cash;
      document.getElementById("hooch").textContent = player.hooch;
      document.getElementById("bullets").textContent = player.bullets;
      document.getElementById("ap").textContent = `${player.ap}/${player.maxAp}`;
      document.getElementById("apBar").style.width = `${(player.ap / player.maxAp) * 100}%`;
      document.getElementById("health").textContent = player.health;
      document.getElementById("health").className = player.health < player.maxHealth * 0.5 ? "border-2 border-red-600 inline-block px-1" : "inline-block";
      document.getElementById("healthBar").style.width = `${(player.health / player.maxHealth) * 100}%`;
      document.getElementById("xp").textContent = player.xp;
      document.getElementById("xpBar").style.width = `${Math.min((player.xp / (ranks.find(r => r.xp > player.xp)?.xp || 10001)) * 100, 100)}%`;
      document.getElementById("influence").textContent = player.influence;
      document.getElementById("perks").textContent = player.perks.length ? player.perks.join(", ") : "None";

      // Inventory with Counts
      const inventory = document.getElementById("inventory");
      const itemCounts = player.inventory.reduce((acc, item) => {
        if (shopItems.some(i => i.name === item)) {
          acc[item] = (acc[item] || 0) + 1;
        }
        return acc;
      }, {});
      const sortedItems = Object.keys(itemCounts).sort((a, b) => {
        if (document.getElementById("sortType").classList.contains("bg-gray-800")) {
          const typeA = shopItems.find(i => i.name === a)?.type || "";
          const typeB = shopItems.find(i => i.name === b)?.type || "";
          return typeA.localeCompare(typeB) || a.localeCompare(b);
        }
        return a.localeCompare(b);
      });
      inventory.innerHTML = sortedItems
        .map(item => {
          const count = itemCounts[item];
          const isEquipped = player.equipped.weapon === item || player.equipped.vehicle === item || player.equipped.clothing === item;
          const itemData = shopItems.find(i => i.name === item);
          const canEquip = itemData && ["Weapon", "Vehicle", "Clothing"].includes(itemData.type) && !isEquipped;
          const equipType = itemData?.type.toLowerCase();
          const sellPrice = itemData.sellPrice || (itemData.cost > 0 ? Math.floor(itemData.cost * 0.5) : Math.floor(itemData.hoochCost * 0.1 * 10));
          return `
            <li class="${isEquipped ? 'border-2 border-yellow-600' : ''}">
              ${item} (${count})
              ${canEquip ? `<button class="equip-item ml-2 px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-item="${item}" data-type="${equipType}">Equip</button>` : ""}
              ${isEquipped ? `<button class="unequip-item ml-2 px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-type="${equipType}">Unequip</button>` : ""}
              <button class="sell-item ml-2 px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-item="${item}">Sell ($${sellPrice})</button>
              <button class="sell-all-item ml-2 px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-item="${item}">Sell All ($${sellPrice * count})</button>
              <button class="drop-item ml-2 px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800 ${isEquipped ? 'opacity-50 cursor-not-allowed' : ''}" data-item="${item}" ${isEquipped ? 'disabled' : ''}>Drop</button>
              <button class="drop-all-item ml-2 px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-800 ${isEquipped ? 'opacity-50 cursor-not-allowed' : ''}" data-item="${item}" ${isEquipped ? 'disabled' : ''}>Drop All</button>
            </li>
          `;
        }).join("") || "Empty";

      // Equipped Items
      document.getElementById("equippedWeapon").textContent = player.equipped.weapon || "None";
      document.getElementById("equippedVehicle").textContent = player.equipped.vehicle || "None";
      document.getElementById("equippedClothing").textContent = player.equipped.clothing || "None";

      // Crimes
      const crimeList = document.getElementById("crimeList");
      let filteredCrimes = crimes.filter(crime => {
        const rankIndex = ranks.findIndex(r => r.name === player.rank);
        if (crime.tier > Math.ceil((rankIndex + 1) / 2)) return false;
        if (currentCrimeFilter === "all") return true;
        if (currentCrimeFilter === `tier-${crime.tier}`) return true;
        if (currentCrimeFilter === "ap-based" && crime.apCost > 0) return true;
        if (currentCrimeFilter === "cooldown-based" && crime.cooldown) return true;
        return false;
      });
      crimeList.innerHTML = filteredCrimes
        .map(crime => {
          const cooldownEnd = player.cooldowns[crime.name] || 0;
          const now = Date.now();
          const remaining = cooldownEnd > now ? Math.ceil((cooldownEnd - now) / 1000) : 0;
          const requirementsMet = crime.requirements.every(req => req === "Crew" ? player.crew : player.inventory.includes(req));
          const disabled = (crime.apCost > 0 && player.ap < crime.apCost) || 
                          (remaining > 0) || 
                          (player.health < player.maxHealth * 0.5) || 
                          !requirementsMet ||
                          (player.bullets < crime.bulletCost);
          const progress = remaining > 0 ? ((crime.cooldown - remaining * 1000) / crime.cooldown) * 100 : 100;
          return `
            <div class="card p-3">
              <h3 class="text-xl art-deco">${crime.name}</h3>
              <p>${crime.apCost > 0 ? `AP Cost: ${crime.apCost}` : `Cooldown: ${crime.cooldown / 3600000} hours`}</p>
              <p>Reward: $${crime.cashMin}–$${crime.cashMax}, ${crime.hoochMin}–${crime.hoochMax} Hooch, ${crime.xpMin * 10}–${crime.xpMax * 10} XP, ${crime.influenceMin}–${crime.influenceMax} Influence</p>
              <p class="text-sm">Risk: ${(crime.risk * 100).toFixed(0)}%</p>
              <p class="text-sm">Bullets: ${crime.bulletCost}</p>
              <p class="text-sm">Health Cost on Failure: ${crime.healthCost}</p>
              <p class="text-sm">Requires: ${crime.requirements.length ? crime.requirements.join(", ") : "None"}</p>
              ${remaining > 0 ? `<p class="text-sm">Cooldown: ${Math.floor(remaining / 60)}m ${remaining % 60}s</p><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div>` : ""}
              <button class="commit-crime group relative mt-2 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 ${disabled ? 'opacity-50 cursor-not-allowed' : ''}" data-crime="${crime.name}" ${disabled ? "disabled" : ""}>
                Commit
                <span class="tooltip">Requires: ${crime.requirements.length ? crime.requirements.join(", ") : "None"}${crime.apCost ? `, ${crime.apCost} AP` : ""}${crime.bulletCost ? `, ${crime.bulletCost} Bullets` : ""}, Health ≥ 50%</span>
              </button>
            </div>
          `;
        }).join("");

      // Shop
      const shopItemsList = document.getElementById("shopItems");
      shopItemsList.innerHTML = shopItems.map(item => {
        const disabled = player.cash < item.cost || player.hooch < item.hoochCost || player.ap < (item.apCost || 0);
        return `
          <div class="card p-3">
            <h3 class="text-xl art-deco">${item.name}</h3>
            <p>Cost: ${item.cost > 0 ? `$${item.cost}` : `${item.hoochCost} Hooch`}${item.apCost ? `, ${item.apCost} AP` : ""}</p>
            <p>Type: ${item.type}</p>
            <p class="text-sm">${item.description}</p>
            <button class="buy-item group relative mt-2 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 ${disabled ? 'opacity-50 cursor-not-allowed' : ''}" data-item="${item.name}" ${disabled ? "disabled" : ""}>
              ${item.type === "Resource" ? "Buy 1" : "Buy"}
              ${item.description && !disabled ? `<span class="tooltip">${item.description}</span>` : ""}
            </button>
            ${item.sellPrice ? `<button class="sell-vehicle group relative mt-2 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 ${!player.inventory.includes(item.name) ? 'opacity-50 cursor-not-allowed' : ''}" data-item="${item.name}" ${!player.inventory.includes(item.name) ? "disabled" : ""}>Sell ($${item.sellPrice})<span class="tooltip">Sell for $${item.sellPrice}</span></button>` : ""}
            ${item.sellPrice ? `<button class="sell-all-vehicle group relative mt-2 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 ${!player.inventory.includes(item.name) ? 'opacity-50 cursor-not-allowed' : ''}" data-item="${item.name}" ${!player.inventory.includes(item.name) ? "disabled" : ""}>Sell All ($${item.sellPrice * (itemCounts[item.name] || 0)})<span class="tooltip">Sell all for $${item.sellPrice * (itemCounts[item.name] || 0)}</span></button>` : ""}
            ${item.scrapBullets ? `<button class="scrap-vehicle group relative mt-2 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 ${!player.inventory.includes(item.name) ? 'opacity-50 cursor-not-allowed' : ''}" data-item="${item.name}" ${!player.inventory.includes(item.name) ? "disabled" : ""}>Scrap (${item.scrapBullets} Bullets)<span class="tooltip">Scrap for ${item.scrapBullets} Bullets</span></button>` : ""}
            ${item.scrapBullets ? `<button class="scrap-all-vehicle group relative mt-2 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 ${!player.inventory.includes(item.name) ? 'opacity-50 cursor-not-allowed' : ''}" data-item="${item.name}" ${!player.inventory.includes(item.name) ? "disabled" : ""}>Scrap All (${item.scrapBullets * (itemCounts[item.name] || 0)} Bullets)<span class="tooltip">Scrap all for ${item.scrapBullets * (itemCounts[item.name] || 0)} Bullets</span></button>` : ""}
          </div>
        `;
      }).join("");

      // Crew
      const crewStatus = document.getElementById("crewStatus");
      crewStatus.innerHTML = player.crew 
        ? `<p>You are in a crew: ${player.crew.name} (Rank: ${player.crew.rank})</p>`
        : `<p>You are a lone wolf. Join or form a crew!</p>`;
      
      // Business
      const businessStatus = document.getElementById("businessStatus");
      businessStatus.innerHTML = player.businesses.length 
        ? player.businesses.map(b => `<p>${b.name}: $${b.dailyIncome}/day ${b.raided ? '🚨 Raided' : '✅ Operational'}</p>`).join("")
        : "No businesses owned.";
    }

    // AP and Health Regeneration
    setInterval(() => {
      if (player.ap < player.maxAp) {
        const regen = player.perks.includes("Coffee") ? 7 : 5;
        player.ap = Math.min(player.maxAp, player.ap + regen);
      }
      if (player.health < player.maxHealth) {
        player.health = Math.min(player.maxHealth, player.health + 5);
      }
      updateUI();
      saveGame();
    }, 60000); // 1 minute

    // Cooldown Progress Update
    setInterval(() => {
      updateUI();
    }, 1000); // 1 second for smooth cooldown progress bars

    // Commit Crime
    document.getElementById("crimeList").addEventListener("click", e => {
      const button = e.target.closest(".commit-crime");
      if (button && !button.disabled) {
        const crimeName = button.dataset.crime;
        console.log(`Attempting to commit crime: ${crimeName}`); // Debug log
        const crime = crimes.find(c => c.name === crimeName);
        if (!crime) {
          logEvent(`Error: Crime ${crimeName} not found!`, "failure");
          return;
        }
        if (player.health < player.maxHealth * 0.5) {
          logEvent("Health too low! Need at least 50% health to commit crimes.", "failure");
          return;
        }
        if (crime.apCost > 0 && player.ap < crime.apCost) {
          logEvent(`Not enough AP! Need ${crime.apCost} AP for ${crime.name}.`, "failure");
          return;
        }
        if (crime.cooldown && player.cooldowns[crime.name] && Date.now() < player.cooldowns[crime.name]) {
          logEvent(`On cooldown for ${crime.name}!`, "failure");
          return;
        }
        if (crime.bulletCost > player.bullets) {
          logEvent(`Not enough Bullets! Need ${crime.bulletCost} Bullets for ${crime.name}.`, "failure");
          return;
        }
        for (const req of crime.requirements) {
          if (req === "Crew" && !player.crew) {
            logEvent(`Need a Crew for ${crime.name}!`, "failure");
            return;
          }
          if (req !== "Crew" && !player.inventory.includes(req)) {
            logEvent(`Missing ${req} for ${crime.name}!`, "failure");
            return;
          }
        }
        player.ap -= crime.apCost;
        player.bullets -= crime.bulletCost;
        if (crime.cooldown) {
          player.cooldowns[crime.name] = Date.now() + crime.cooldown * (player.perks.includes("Fast Talker") ? 0.9 : 1);
        }
        const success = Math.random() > crime.risk * (1 - getSuccessBonus());
        if (success) {
          const cash = Math.floor(Math.random() * (crime.cashMax - crime.cashMin + 1)) + crime.cashMin;
          const hooch = Math.floor(Math.random() * (crime.hoochMax - crime.hoochMin + 1)) + crime.hoochMin;
          const xp = (Math.floor(Math.random() * (crime.xpMax - crime.xpMin + 1)) + crime.xpMin) * 10; // Temporary x10 for testing
          const influence = Math.floor(Math.random() * (crime.influenceMax - crime.influenceMin + 1)) + crime.influenceMin + getInfluenceBonus();
          let extra = "";
          if (crime.name === "Steal a Car" && !player.equipped.vehicle) {
            const vehicle = Math.random() < 0.8 ? "Ford Model T" : "Cadillac";
            player.inventory.push(vehicle);
            extra = ` Stole a ${vehicle}!`;
          } else if (crime.name === "Steal a Car") {
            player.cash += cash;
            extra = ` Sold stolen car for $${cash}.`;
          } else {
            player.cash += cash;
          }
          if (["Liquor Shipment Hijack", "Bank Heist"].includes(crime.name)) {
            const bullets = Math.floor(Math.random() * 5) + 1;
            player.bullets += bullets;
            extra += ` Looted ${bullets} Bullets.`;
          }
          player.hooch += hooch;
          player.xp += xp;
          player.influence += influence;
          logEvent(`Success! Gained $${cash}, ${hooch} Hooch, ${xp} XP, ${influence} Influence from ${crime.name}.${extra}`, "success");
          updateRank();
        } else {
          player.health = Math.max(0, player.health - crime.healthCost);
          player.cash = Math.max(0, player.cash - 100);
          logEvent(`Failed ${crime.name}! Lost $100 and ${crime.healthCost} Health.`, "failure");
        }
        updateUI();
        saveGame();
      }
    });

    // Quick Pickpocket
    document.getElementById("quickPickpocket").addEventListener("click", () => {
      console.log("Quick Pickpocket clicked"); // Debug log
      const crime = crimes.find(c => c.name === "Pickpocketing");
      if (player.health < player.maxHealth * 0.5) {
        logEvent("Health too low! Need at least 50% health to commit crimes.", "failure");
        return;
      }
      if (player.ap < crime.apCost) {
        logEvent(`Not enough AP! Need ${crime.apCost} AP for Pickpocketing.`, "failure");
        return;
      }
      player.ap -= crime.apCost;
      const success = Math.random() > crime.risk * (1 - getSuccessBonus());
      if (success) {
        const cash = Math.floor(Math.random() * (crime.cashMax - crime.cashMin + 1)) + crime.cashMin;
        const hooch = Math.floor(Math.random() * (crime.hoochMax - crime.hoochMin + 1)) + crime.hoochMin;
        const xp = (Math.floor(Math.random() * (crime.xpMax - crime.xpMin + 1)) + crime.xpMin) * 10; // Temporary x10 for testing
        const influence = Math.floor(Math.random() * (crime.influenceMax - crime.influenceMin + 1)) + crime.influenceMin + getInfluenceBonus();
        player.cash += cash;
        player.hooch += hooch;
        player.xp += xp;
        player.influence += influence;
        logEvent(`Success! Gained $${cash}, ${hooch} Hooch, ${xp} XP, ${influence} Influence from Pickpocketing.`, "success");
        updateRank();
      } else {
        player.health = Math.max(0, player.health - crime.healthCost);
        player.cash = Math.max(0, player.cash - 100);
        logEvent(`Failed Pickpocketing! Lost $100 and ${crime.healthCost} Health.`, "failure");
      }
      updateUI();
      saveGame();
    });

    // Buy/Sell/Equip/Unequip/Drop Items
    document.addEventListener("click", e => {
      if (e.target.classList.contains("buy-item") || e.target.id === "quickBuyHooch") {
        const itemName = e.target.dataset.item || "Hooch";
        if (itemName === "Hooch") {
          const cost = Math.floor(Math.random() * 41) + 10;
          if (player.cash >= cost) {
            player.cash -= cost;
            player.hooch += 1;
            logEvent(`Bought 1 Hooch for $${cost}.`, "success");
            updateUI();
            saveGame();
          } else {
            logEvent("Not enough cash!", "failure");
          }
          return;
        }
        const item = shopItems.find(i => i.name === itemName);
        if (player.cash >= item.cost && player.hooch >= item.hoochCost && player.ap >= (item.apCost || 0)) {
          player.cash -= item.cost;
          player.hooch -= item.hoochCost;
          player.ap -= item.apCost || 0;
          if (item.name === "Bullets") {
            player.bullets += 1;
          } else if (item.type === "Consumable") {
            if (item.name === "Coffee" && !player.perks.includes("Coffee")) {
              player.perks.push("Coffee");
              setTimeout(() => {
                player.perks = player.perks.filter(p => p !== "Coffee");
                updateUI();
                saveGame();
              }, item.bonus.duration);
            } else if (item.name === "First Aid Kit") {
              player.health = player.maxHealth;
            } else if (item.name === "Whiskey Shot") {
              player.health = Math.min(player.maxHealth, player.health + item.bonus.health);
            }
          } else if (item.type === "Perk") {
            player.perks.push(item.name);
          } else {
            player.inventory.push(item.name);
          }
          logEvent(`Bought ${item.name} for $${item.cost}${item.hoochCost ? ` and ${item.hoochCost} Hooch` : ""}${item.apCost ? ` and ${item.apCost} AP` : ""}.`, "success");
          updateUI();
          saveGame();
        } else {
          logEvent(`Not enough resources to buy ${item.name}!`, "failure");
        }
      }
      if (e.target.classList.contains("sell-vehicle")) {
        const itemName = e.target.dataset.item;
        const item = shopItems.find(i => i.name === itemName);
        if (player.inventory.includes(itemName)) {
          player.inventory.splice(player.inventory.indexOf(itemName), 1);
          if (player.equipped.vehicle === itemName) player.equipped.vehicle = null;
          player.cash += item.sellPrice;
          logEvent(`Sold ${itemName} for $${item.sellPrice}.`, "success");
          updateUI();
          saveGame();
        }
      }
      if (e.target.classList.contains("sell-all-vehicle")) {
        const itemName = e.target.dataset.item;
        const item = shopItems.find(i => i.name === itemName);
        const count = player.inventory.filter(i => i === itemName).length;
        if (count > 0) {
          player.inventory = player.inventory.filter(i => i !== itemName);
          if (player.equipped.vehicle === itemName) player.equipped.vehicle = null;
          player.cash += item.sellPrice * count;
          logEvent(`Sold ${count} ${itemName}(s) for $${item.sellPrice * count}.`, "success");
          updateUI();
          saveGame();
        }
      }
      if (e.target.classList.contains("scrap-vehicle")) {
        const itemName = e.target.dataset.item;
        const item = shopItems.find(i => i.name === itemName);
        if (player.inventory.includes(itemName)) {
          player.inventory.splice(player.inventory.indexOf(itemName), 1);
          if (player.equipped.vehicle === itemName) player.equipped.vehicle = null;
          player.bullets += item.scrapBullets;
          logEvent(`Scrapped ${itemName} for ${item.scrapBullets} Bullets.`, "success");
          updateUI();
          saveGame();
        }
      }
      if (e.target.classList.contains("scrap-all-vehicle")) {
        const itemName = e.target.dataset.item;
        const item = shopItems.find(i => i.name === itemName);
        const count = player.inventory.filter(i => i === itemName).length;
        if (count > 0) {
          player.inventory = player.inventory.filter(i => i !== itemName);
          if (player.equipped.vehicle === itemName) player.equipped.vehicle = null;
          player.bullets += item.scrapBullets * count;
          logEvent(`Scrapped ${count} ${itemName}(s) for ${item.scrapBullets * count} Bullets.`, "success");
          updateUI();
          saveGame();
        }
      }
      if (e.target.classList.contains("sell-item")) {
        const itemName = e.target.dataset.item;
        if (player.inventory.includes(itemName)) {
          const item = shopItems.find(i => i.name === itemName);
          const sellPrice = item.sellPrice || (item.cost > 0 ? Math.floor(item.cost * 0.5) : Math.floor(item.hoochCost * 0.1 * 10));
          player.inventory.splice(player.inventory.indexOf(itemName), 1);
          if (player.equipped.weapon === itemName) player.equipped.weapon = null;
          if (player.equipped.vehicle === itemName) player.equipped.vehicle = null;
          if (player.equipped.clothing === itemName) player.equipped.clothing = null;
          player.cash += sellPrice;
          logEvent(`Sold ${itemName} for $${sellPrice}.`, "success");
          updateUI();
          saveGame();
        }
      }
      if (e.target.classList.contains("sell-all-item")) {
        const itemName = e.target.dataset.item;
        const count = player.inventory.filter(i => i === itemName).length;
        if (count > 0) {
          const item = shopItems.find(i => i.name === itemName);
          const sellPrice = item.sellPrice || (item.cost > 0 ? Math.floor(item.cost * 0.5) : Math.floor(item.hoochCost * 0.1 * 10));
          player.inventory = player.inventory.filter(i => i !== itemName);
          if (player.equipped.weapon === itemName) player.equipped.weapon = null;
          if (player.equipped.vehicle === itemName) player.equipped.vehicle = null;
          if (player.equipped.clothing === itemName) player.equipped.clothing = null;
          player.cash += sellPrice * count;
          logEvent(`Sold ${count} ${itemName}(s) for $${sellPrice * count}.`, "success");
          updateUI();
          saveGame();
        }
      }
      if (e.target.classList.contains("drop-item") && !e.target.disabled) {
        const itemName = e.target.dataset.item;
        if (player.inventory.includes(itemName)) {
          player.inventory.splice(player.inventory.indexOf(itemName), 1);
          logEvent(`Dropped ${itemName}.`, "info");
          updateUI();
          saveGame();
        }
      }
      if (e.target.classList.contains("drop-all-item") && !e.target.disabled) {
        const itemName = e.target.dataset.item;
        const count = player.inventory.filter(i => i === itemName).length;
        if (count > 0) {
          player.inventory = player.inventory.filter(i => i !== itemName);
          logEvent(`Dropped ${count} ${itemName}(s).`, "info");
          updateUI();
          saveGame();
        }
      }
      if (e.target.classList.contains("equip-item")) {
        const itemName = e.target.dataset.item;
        const type = e.target.dataset.type;
        if (player.inventory.includes(itemName)) {
          player.equipped[type] = itemName;
          logEvent(`Equipped ${itemName}.`, "success");
          updateUI();
          saveGame();
        }
      }
      if (e.target.classList.contains("unequip-item")) {
        const type = e.target.dataset.type;
        player.equipped[type] = null;
        logEvent(`Unequipped ${type}.`, "success");
        updateUI();
        saveGame();
      }
      if (e.target.id === "clearLog") {
        document.getElementById("eventLog").innerHTML = "";
      }
      if (e.target.id === "toggleTimestamps") {
        showTimestamps = !showTimestamps;
        document.getElementById("eventLog").classList.toggle("hide-timestamp");
        e.target.textContent = showTimestamps ? "Toggle Timestamps" : "Show Timestamps";
      }
      if (e.target.id === "quickActionToggle") {
        document.getElementById("quickActions").classList.toggle("hidden");
      }
      if (e.target.classList.contains("filter-crime")) {
        currentCrimeFilter = e.target.dataset.filter;
        document.querySelectorAll(".filter-crime").forEach(btn => btn.classList.remove("bg-gray-800"));
        e.target.classList.add("bg-gray-800");
        updateUI();
      }
      if (e.target.id === "sortName") {
        document.getElementById("sortName").classList.add("bg-gray-800");
        document.getElementById("sortType").classList.remove("bg-gray-800");
        updateUI();
      }
      if (e.target.id === "sortType") {
        document.getElementById("sortType").classList.add("bg-gray-800");
        document.getElementById("sortName").classList.remove("bg-gray-800");
        updateUI();
      }
      if (e.target.id === "themeToggle") {
        const isDark = document.body.classList.contains("dark-theme");
        document.body.classList.toggle("dark-theme");
        document.body.classList.toggle("light-theme");
        e.target.textContent = isDark ? "Switch to Dark Theme" : "Switch to Light Theme";
        localStorage.setItem("theme", isDark ? "light" : "dark");
        updateUI();
      }
    });

    // Hooch Transactions
    document.getElementById("buyHooch").addEventListener("click", () => {
      const cost = Math.floor(Math.random() * 41) + 10;
      if (player.cash >= cost) {
        player.cash -= cost;
        player.hooch += 1;
        logEvent(`Bought 1 Hooch for $${cost}.`, "success");
        updateUI();
        saveGame();
      } else {
        logEvent("Not enough cash!", "failure");
      }
    });

    document.getElementById("sellHooch").addEventListener("click", () => {
      if (player.hooch >= 1) {
        const price = Math.floor(Math.random() * 33) + 8;
        player.hooch -= 1;
        player.cash += price;
        logEvent(`Sold 1 Hooch for $${price}.`, "success");
        updateUI();
        saveGame();
      } else {
        logEvent("Not enough Hooch!", "failure");
      }
    });

    // Crew Management
    document.getElementById("joinCrew").addEventListener("click", () => {
      if (player.rank !== "Greenhorn") {
        player.crew = { name: "Generic Crew", rank: "Soldier" };
        logEvent("Joined a crew!", "success");
        updateUI();
        saveGame();
      } else {
        logEvent("Need to be at least Soldier rank to join a crew!", "failure");
      }
    });

    document.getElementById("formCrew").addEventListener("click", () => {
      if (player.rank === "Consigliere" && player.cash >= 5000 && player.influence >= 201) {
        player.cash -= 5000;
        player.crew = { name: `${player.name}'s Family`, rank: "Boss" };
        logEvent("Formed your own crew!", "success");
        updateUI();
        saveGame();
      } else {
        logEvent("Need Consigliere rank, $5,000, and 201 Influence to form a crew!", "failure");
      }
    });

    // Gambling
    const gamblingGames = {
      playPoker: { winChance: 0.5, multiplier: 2 },
      playBlackjack: { winChance: 0.5, multiplier: 2 },
      playKeno: { winChance: 0.5, multiplier: 2 },
      playHorseRacing: { winChance: 0.2, multiplier: 5 },
      playRoulette: { winChance: 0.48, multiplier: 2 },
      playThreeCardMonte: { winChance: 0.33, multiplier: 3 },
      playCraps: { winChance: 0.5, multiplier: 2 }
    };

    Object.keys(gamblingGames).forEach(game => {
      document.getElementById(game).addEventListener("click", () => {
        const bet = parseInt(document.getElementById("betAmount").value);
        if (player.cash >= bet && bet >= 5 && bet <= 100) {
          player.cash -= bet;
          const gameName = game.replace("play", "");
          document.getElementById("gamblingResult").textContent = "";
          const betHistory = document.getElementById("betHistory");
          if (Math.random() < gamblingGames[game].winChance) {
            const winnings = bet * gamblingGames[game].multiplier;
            player.cash += winnings;
            document.getElementById("gamblingResult").className = "text-green-600";
            document.getElementById("gamblingResult").textContent = `Won $${winnings} at ${gameName}!`;
            betHistory.innerHTML += `<p class="text-green-600">${new Date().toLocaleTimeString()}: Won $${winnings} at ${gameName}</p>`;
            logEvent(`Won $${winnings} at ${gameName}!`, "success");
          } else {
            document.getElementById("gamblingResult").className = "text-red-600";
            document.getElementById("gamblingResult").textContent = `Lost $${bet} at ${gameName}.`;
            betHistory.innerHTML += `<p class="text-red-600">${new Date().toLocaleTimeString()}: Lost $${bet} at ${gameName}</p>`;
            logEvent(`Lost $${bet} at ${gameName}.`, "failure");
          }
          betHistory.scrollTop = betHistory.scrollHeight;
          const historyEntries = betHistory.getElementsByTagName("p");
          while (historyEntries.length > 20) historyEntries[0].remove();
          updateUI();
          saveGame();
        } else {
          logEvent("Invalid bet amount!", "failure");
        }
      });
    });

    // Chat
    document.getElementById("sendChat").addEventListener("click", () => {
      const message = document.getElementById("chatInput").value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      if (message) {
        const chatMessages = document.getElementById("chatMessages");
        const messageCount = chatMessages.getElementsByTagName("p").length;
        chatMessages.innerHTML += `<p class="${messageCount % 2 === 0 ? 'tab-bg' : 'bg-gray-200'} p-1"><strong>${player.name}:</strong> ${message}</p>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        document.getElementById("chatInput").value = "";
      }
    });

    // Business
    document.getElementById("buySpeakeasy").addEventListener("click", () => {
      if (player.cash >= 1000 && player.inventory.includes("Safehouse") && !player.businesses.some(b => b.name === "Speakeasy")) {
        player.cash -= 1000;
        player.businesses.push({ name: "Speakeasy", dailyIncome: 50, raided: false });
        logEvent("Bought a Speakeasy!", "success");
        updateUI();
        saveGame();
      } else {
        logEvent("Need $1,000 and a Safehouse, or already own a Speakeasy!", "failure");
      }
    });

    document.getElementById("buyDistillery").addEventListener("click", () => {
      if (player.cash >= 2500 && !player.businesses.some(b => b.name === "Distillery")) {
        player.cash -= 2500;
        player.businesses.push({ name: "Distillery", dailyIncome: 100, raided: false });
        logEvent("Bought a Distillery!", "success");
        updateUI();
        saveGame();
      } else {
        logEvent("Not enough cash or already own a Distillery!", "failure");
      }
    });

    // Daily Business Income
    setInterval(() => {
      player.businesses.forEach(b => {
        let raidRisk = 0.1;
        if (player.perks.includes("Connected")) raidRisk *= 0.8;
        if (player.inventory.includes("Bribe Money")) {
          player.inventory.splice(player.inventory.indexOf("Bribe Money"), 1);
          raidRisk *= 0.9;
        }
        b.raided = Math.random() <= raidRisk;
        if (!b.raided) {
          const income = Math.floor(Math.random() * (b.dailyIncome * 2 - b.dailyIncome + 1)) + b.dailyIncome;
          player.cash += income;
          logEvent(`${b.name} earned $${income} today.`, "success");
          if (b.name === "Speakeasy" && player.inventory.filter(i => i === "Liquor Crate").length >= 2) {
            let cratesRemoved = 0;
            player.inventory = player.inventory.filter(i => {
              if (i === "Liquor Crate" && cratesRemoved < 2) {
                cratesRemoved++;
                return false;
              }
              return true;
            });
          } else if (b.name === "Speakeasy") {
            logEvent("Speakeasy needs 2 Liquor Crates to operate!", "failure");
            b.raided = true;
          }
          if (b.name === "Distillery") {
            const crates = Math.floor(Math.random() * 3) + 3;
            for (let i = 0; i < crates; i++) player.inventory.push("Liquor Crate");
            logEvent(`Distillery produced ${crates} Liquor Crates.`, "success");
          }
        } else {
          logEvent(`${b.name} was raided! No income today.`, "failure");
        }
      });
      if (player.businesses.some(b => b.name === "Distillery")) {
        player.cash = Math.max(0, player.cash - 500);
        logEvent("Paid $500 Distillery upkeep.", "info");
      }
      updateUI();
      saveGame();
    }, 86400000); // 24 hours

    // Daily Moonshine Still Production
    setInterval(() => {
      if (player.inventory.includes("Moonshine Still")) {
        player.inventory.push("Liquor Crate");
        logEvent("Moonshine Still produced 1 Liquor Crate.", "success");
        updateUI();
        saveGame();
      }
    }, 86400000); // 24 hours

    // Random Events
    setInterval(() => {
      if (player.influence > 50 && Math.random() < 0.05) {
        player.health = Math.max(0, player.health - 20);
        logEvent(`Rival gang attacked! Lost 20 Health.`, "failure");
        updateUI();
        saveGame();
      }
    }, 3600000); // 1 hour

    // Helper Functions
    function getSuccessBonus() {
      return Object.values(player.equipped).reduce((bonus, item) => {
        if (!item) return bonus;
        const shopItem = shopItems.find(i => i.name === item);
        return bonus + (shopItem?.bonus.success || 0) + (shopItem?.bonus.getaway || 0);
      }, player.crew ? 0.1 : 0);
    }

    function getInfluenceBonus() {
      return Object.values(player.equipped).reduce((bonus, item) => {
        if (!item) return bonus;
        const shopItem = shopItems.find(i => i.name === item);
        return bonus + (shopItem?.bonus.influence || 0);
      }, 0);
    }

    function updateRank() {
      for (let i = ranks.length - 1; i >= 0; i--) {
        if (player.xp >= ranks[i].xp && player.influence >= ranks[i].influence) {
          if (player.rank !== ranks[i].name) {
            player.rank = ranks[i].name;
            logEvent(`Promoted to ${player.rank}!`, "success");
          }
          break;
        }
      }
    }

    function logEvent(message, type = "info") {
      const eventLog = document.getElementById("eventLog");
      const classMap = {
        info: "text-gray-800",
        success: "text-green-600",
        failure: "text-red-600"
      };
      eventLog.innerHTML += `<p class="${classMap[type]}"><span class="timestamp">${new Date().toLocaleTimeString()}: </span>${message}</p>`;
      const entries = eventLog.getElementsByTagName("p");
      while (entries.length > 50) entries[0].remove();
      eventLog.scrollTop = eventLog.scrollHeight;
    }

    // Tab Navigation
    document.querySelectorAll(".tab-button").forEach(button => {
      button.addEventListener("click", () => {
        document.querySelectorAll(".tab-content").forEach(content => content.classList.add("hidden"));
        document.getElementById(button.dataset.tab).classList.remove("hidden");
        document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("bg-gray-300"));
        button.classList.add("bg-gray-300");
      });
    });

    // Initialize
    loadGame();
    document.querySelector(".tab-button[data-tab='crimes']").click();
  </script>
</body>
</html>