<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prohibition Kings</title>
    <style>
        body {
            background-color: #000000;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            margin: 10px;
        }
        button {
            background-color: #666666;
            color: #FFFFFF;
            border: none;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #333333;
            cursor: not-allowed;
        }
        .tab {
            display: none;
        }
        .tab.active {
            display: block;
        }
        .nav-link {
            color: #FFFFFF;
            text-decoration: none;
            margin: 0 10px;
            cursor: pointer;
        }
        .nav-link.active {
            font-weight: bold;
            text-decoration: underline;
        }
        .bordered {
            border: 1px solid #FFFFFF;
            padding: 10px;
            margin: 5px 0;
            min-height: 100px;
            overflow: visible;
        }
        .bordered.black-market {
            margin-bottom: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #333333;
            border: 1px solid #FFFFFF;
            margin: 5px 0;
        }
        .energy-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.5s;
        }
        .health-fill {
            height: 100%;
            background-color: #FF6347;
            transition: width 0.5s;
        }
        .cooldown-fill {
            height: 100%;
            background-color: #1976D2;
            transition: width 0.5s;
        }
        h2 {
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div class="bordered">
        <h1>Prohibition Kings</h1>
        <p id="player-stats">Player: Unknown | Rank: Thug | Cash: $0 | XP: 0 | Influence: 0 | Energy: 10000 | Gold: 0 | Health: 100</p>
        <div class="progress-bar"><div class="health-fill" id="health-fill" style="width: 100%;"></div></div>
    </div>
    <div class="bordered">
        <a class="nav-link active" onclick="showTab('crimes')">Crimes</a>
        <a class="nav-link" onclick="showTab('inventory')">Inventory</a>
        <a class="nav-link" onclick="showTab('speakeasy')">Speakeasy</a>
        <a class="nav-link" onclick="showTab('profile')">Profile</a>
    </div>
    <div id="crimes" class="tab active">
        <div class="bordered">
            <h2>Available Crimes</h2>
            <p>Energy: <span id="energy-text">10000</span></p>
            <div class="progress-bar"><div class="energy-fill" id="energy-fill" style="width: 100%;"></div></div>
            <div id="crime-list"></div>
            <div id="crime-results"></div>
        </div>
    </div>
    <div id="inventory" class="tab">
        <div class="bordered black-market">
            <h2>Black Market Items</h2>
            <div id="inventory-list"></div>
            <div id="market-list"></div>
        </div>
    </div>
    <div id="speakeasy" class="tab">
        <div class="bordered">
            <h2>Speakeasy</h2>
            <h3>Dice Roll</h3>
            <input type="number" id="bet-amount" min="10" max="100" value="10">
            <button onclick="gamble()">Bet Cash</button>
            <button onclick="gambleGold()">Bet 1 Gold</button>
            <p id="gamble-result"></p>
        </div>
    </div>
    <div id="profile" class="tab">
        <div class="bordered">
            <h2>Profile</h2>
            <p id="profile-stats"></p>
            <div class="progress-bar"><div class="health-fill" id="health-fill-profile" style="width: 100%;"></div></div>
        </div>
    </div>
    <div class="bordered">
        <button onclick="logout()">Logout</button>
    </div>
    <script>
        let player = {
            name: "Player",
            rank: "Thug",
            cash: 0,
            xp: 0,
            influence: 0,
            energy: 10000,
            gold: 0,
            items: [],
            health: 100,
            lastEnergyUpdate: Date.now(),
            crimeAttempts: { "Speakeasy Heist": { timestamps: [] } },
            crimeResults: []
        };

        const crimes = [
            { name: "Pickpocketing", cash: [1, 5], xp: 5, influence: 2, energy: 10, risk: 0.1, tooltip: "Grab some dough from unsuspecting marks." },
            { name: "Bootleg Run", cash: [10, 20], xp: 10, influence: 5, energy: 15, risk: 0.15, tooltip: "Smuggle hooch past the coppers." },
            { name: "Speakeasy Heist", cash: [500, 2000], xp: 100, influence: 50, gold: [2, 5], risk: 0.25, maxPerDay: 3, tooltip: "Knock over a rival juice joint for big dough." }
        ];

        const market = [
            { name: "Crowbar", price: 10, effect: { crime: "Pickpocketing", success: 0.05 }, tooltip: "Boosts Pickpocketing by 5% (1 max)." },
            { name: "Revolver", price: 50, effect: { crime: "Speakeasy Heist", success: 0.1 }, tooltip: "Boosts Speakeasy Heist by 10% (1 max)." },
            { name: "Bribe", price: 100, effect: { risk: -0.1 }, tooltip: "Cuts all crime risk by 10% (1 max)." },
            { name: "Gold", price: 10000, tooltip: "Trade $10,000 for a shiny gold coin." }
        ];

        function savePlayer() {
            console.log("Saving player:", JSON.stringify(player));
            localStorage.setItem("prohibitionPlayer", JSON.stringify(player));
        }

        function loadPlayer() {
            console.log("Loading player...");
            const saved = localStorage.getItem("prohibitionPlayer");
            if (saved) {
                player = JSON.parse(saved);
                console.log("Loaded player:", JSON.stringify(player));
                // Ensure crimeResults is initialized
                if (!player.crimeResults) {
                    player.crimeResults = [];
                }
                // Remove duplicate items (keep first instance, except Gold)
                const uniqueItems = [];
                for (let item of player.items) {
                    if (item === "Gold" || !uniqueItems.includes(item)) {
                        uniqueItems.push(item);
                    }
                }
                player.items = uniqueItems;
                // Clean up unused crimeAttempts counts
                player.crimeAttempts = { "Speakeasy Heist": player.crimeAttempts["Speakeasy Heist"] || { timestamps: [] } };
            }
            updateEnergy();
            savePlayer();
        }

        function updateEnergy() {
            console.log("Updating energy...");
            const now = Date.now();
            const minutesPassed = (now - player.lastEnergyUpdate) / 60000;
            player.energy = Math.min(10000, player.energy + Math.floor(minutesPassed * 5));
            player.lastEnergyUpdate = now;
            savePlayer();
        }

        function updateUI() {
            console.log("Updating UI...");
            try {
                updateEnergy();
                const stats = `Player: ${player.name} | Rank: ${player.rank} | Cash: $${player.cash} | XP: ${player.xp} | Influence: ${player.influence} | Energy: ${player.energy} | Gold: ${player.gold} | Health: ${player.health}`;
                document.getElementById("player-stats").textContent = stats;
                document.getElementById("profile-stats").textContent = stats;
                
                // Update Crimes tab
                const crimesTab = document.getElementById("crimes");
                if (crimesTab.classList.contains("active")) {
                    document.getElementById("energy-text").textContent = player.energy;
                    document.getElementById("energy-fill").style.width = `${(player.energy / 10000) * 100}%`;
                    console.log("Generating crime list...");
                    let crimeList = "";
                    const now = Date.now();
                    let bribeActive = player.items.includes("Bribe");
                    for (let crime of crimes) {
                        console.log(`Processing crime: ${crime.name}, Energy: ${player.energy}, XP: ${player.xp}`);
                        let canAttempt = true;
                        let status = crime.tooltip;
                        let adjustedRisk = crime.risk;
                        let successBoost = 0;
                        if (bribeActive) adjustedRisk = Math.max(0, adjustedRisk - 0.1);
                        if (crime.name === "Pickpocketing" && player.items.includes("Crowbar")) successBoost += 0.05;
                        if (crime.name === "Speakeasy Heist" && player.items.includes("Revolver")) successBoost += 0.1;
                        adjustedRisk = Math.max(0, adjustedRisk - successBoost);
                        if (crime.name === "Speakeasy Heist" && player.xp < 500) {
                            canAttempt = false;
                            status = "Need Capo rank (500 XP)";
                        } else if (crime.energy && player.energy < crime.energy) {
                            canAttempt = false;
                            status = `Need ${crime.energy} Energy`;
                        } else if (crime.maxPerDay) {
                            const attempts = player.crimeAttempts[crime.name].timestamps.filter(t => now - t < 86400000);
                            console.log(`${crime.name} attempts:`, attempts);
                            if (attempts.length >= crime.maxPerDay) {
                                canAttempt = false;
                                const earliest = Math.min(...player.crimeAttempts[crime.name].timestamps);
                                const remaining = Math.ceil((86400000 - (now - earliest)) / 3600000);
                                status = `Next attempt in ${remaining} hours`;
                            }
                        }
                        crimeList += `
                            <div class="bordered">
                                <p>${crime.name}: $${crime.cash[0]}-$${crime.cash[1]}, ${crime.xp} XP, ${crime.influence} Influence${crime.gold ? `, ${crime.gold[0]}-${crime.gold[1]} Gold` : ""}, ${crime.energy ? crime.energy + " Energy" : crime.maxPerDay + "/day"} (Risk: ${(adjustedRisk * 100).toFixed(1)}%)</p>
                                <p>Status: ${status}</p>
                                ${crime.maxPerDay ? `<div class="progress-bar"><div class="cooldown-fill" style="width: ${100 - ((player.crimeAttempts[crime.name].timestamps.filter(t => now - t < 86400000).length / crime.maxPerDay) * 100)}%"></div></div>` : ""}
                                <button ${canAttempt ? "" : "disabled"} onclick="commitCrime('${crime.name}')">Attempt</button>
                            </div>`;
                    }
                    console.log("Crime list HTML:", crimeList);
                    document.getElementById("crime-list").innerHTML = crimeList || "<p>No crimes available. Check console.</p>";

                    console.log("Rendering crime results:", player.crimeResults);
                    let resultsList = player.crimeResults.length ? "" : "<p>No recent crime results.</p>";
                    for (let result of player.crimeResults) {
                        resultsList += `<div class="bordered"><p>${result}</p></div>`;
                        console.log("Rendered crime result to DOM:", result);
                    }
                    document.getElementById("crime-results").innerHTML = resultsList;
                }

                // Update Inventory tab
                const inventoryTab = document.getElementById("inventory");
                if (inventoryTab.classList.contains("active")) {
                    let inventoryList = "<p>Owned Items:</p>";
                    if (player.items.length === 0) {
                        inventoryList += "<p>None</p>";
                    } else {
                        for (let itemName of player.items) {
                            const item = market.find(i => i.name === itemName);
                            if (item) {
                                inventoryList += `<p>${item.name}: Active - ${item.tooltip}</p>`;
                            }
                        }
                    }
                    inventoryList += `<p>Cash: $${player.cash} | Gold: ${player.gold}</p>`;
                    document.getElementById("inventory-list").innerHTML = inventoryList;

                    let marketList = "";
                    for (let item of market) {
                        const owned = player.items.includes(item.name) && item.name !== "Gold";
                        marketList += `
                            <div class="bordered">
                                <p>${item.name}: $${item.price} - ${item.tooltip}</p>
                                <button ${owned || player.cash < item.price ? "disabled" : ""} onclick="buyItem('${item.name}')">Buy</button>
                            </div>`;
                    }
                    document.getElementById("market-list").innerHTML = marketList;
                }

                document.getElementById("health-fill").style.width = `${player.health}%`;
                document.getElementById("health-fill-profile").style.width = `${player.health}%`;
            } catch (e) {
                console.error("UI update error:", e);
                document.getElementById("crime-list").innerHTML = "<p>Error loading crimes. Check console.</p>";
            }
        }

        function commitCrime(crimeName) {
            console.log(`Attempting crime: ${crimeName}`);
            const crime = crimes.find(c => c.name === crimeName);
            if (!crime) {
                console.log("Crime not found:", crimeName);
                return;
            }
            const now = Date.now();
            if (crime.energy && player.energy < crime.energy) {
                console.log("Not enough Energy for", crimeName);
                return;
            }
            if (crime.maxPerDay) {
                const attempts = player.crimeAttempts[crime.name].timestamps.filter(t => now - t < 86400000);
                if (attempts.length >= crime.maxPerDay) {
                    console.log("Max attempts reached for", crimeName);
                    return;
                }
                player.crimeAttempts[crime.name].timestamps.push(now);
            }
            if (crime.energy) player.energy -= crime.energy;

            let risk = crime.risk;
            let successBoost = 0;
            if (player.items.includes("Bribe")) {
                risk = Math.max(0, risk - 0.1);
                console.log(`Bribe applied: -10% risk for ${crimeName}`);
            }
            if (crime.name === "Pickpocketing" && player.items.includes("Crowbar")) {
                successBoost += 0.05;
                console.log(`Crowbar applied: +5% success for ${crimeName}`);
            }
            if (crime.name === "Speakeasy Heist" && player.items.includes("Revolver")) {
                successBoost += 0.1;
                console.log(`Revolver applied: +10% success for ${crimeName}`);
            }
            risk = Math.max(0, risk - successBoost);
            console.log(`Crime: ${crimeName}, Adjusted Risk: ${(risk * 100).toFixed(1)}%, Success Boost: ${(successBoost * 100).toFixed(1)}%`);

            const success = Math.random() > risk;
            let message = "";
            if (success) {
                const cash = Math.floor(Math.random() * (crime.cash[1] - crime.cash[0] + 1)) + crime.cash[0];
                player.cash += cash;
                player.xp += crime.xp;
                player.influence += crime.influence;
                if (crime.gold) {
                    const gold = Math.floor(Math.random() * (crime.gold[1] - crime.gold[0] + 1)) + crime.gold[0];
                    player.gold += gold;
                    message = `Success: Snagged $${cash}, ${crime.xp} XP, ${crime.influence} Influence, ${gold} Gold.`;
                } else {
                    message = `Success: Snagged $${cash}, ${crime.xp} XP, ${crime.influence} Influence.`;
                }
            } else {
                message = "Failed: Try again!";
            }
            console.log(`Crime result: ${message}`);
            player.crimeResults.push(message);
            if (player.crimeResults.length > 5) player.crimeResults.shift();
            updateRank();
            savePlayer();
            updateUI();
        }

        function buyItem(itemName) {
            console.log(`Buying item: ${itemName}`);
            const item = market.find(i => i.name === itemName);
            if (!item || player.cash < item.price || (item.name !== "Gold" && player.items.includes(item.name))) {
                console.log("Cannot buy:", !item ? "Item not found" : player.cash < item.price ? "Not enough cash" : "Item already owned");
                return;
            }
            player.cash -= item.price;
            if (itemName === "Gold") player.gold++;
            else player.items.push(itemName);
            savePlayer();
            updateUI();
        }

        function gamble() {
            console.log("Gambling cash...");
            const bet = parseInt(document.getElementById("bet-amount").value);
            if (bet < 10 || bet > 100 || player.cash < bet) {
                console.log("Invalid bet:", bet);
                return;
            }
            player.cash -= bet;
            const win = Math.random() < 0.5;
            const result = win ? `Won $${bet * 2}!` : `Lost $${bet}.`;
            if (win) player.cash += bet * 2;
            document.getElementById("gamble-result").textContent = result;
            savePlayer();
            updateUI();
        }

        function gambleGold() {
            console.log("Gambling gold...");
            if (player.gold < 1) {
                console.log("Not enough Gold");
                return;
            }
            player.gold--;
            const win = Math.random() < 0.5;
            const result = win ? `Won 2 Gold!` : `Lost 1 Gold.`;
            if (win) player.gold += 2;
            document.getElementById("gamble-result").textContent = result;
            savePlayer();
            updateUI();
        }

        function updateRank() {
            if (player.xp >= 2000) player.rank = "Boss";
            else if (player.xp >= 500) player.rank = "Capo";
            else if (player.xp >= 100) player.rank = "Enforcer";
            else player.rank = "Thug";
        }

        function showTab(tabId) {
            console.log(`Showing tab: ${tabId}`);
            document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
            document.querySelectorAll(".nav-link").forEach(link => link.classList.remove("active"));
            document.getElementById(tabId).classList.add("active");
            document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add("active");
            setTimeout(() => {
                player.crimeResults = [];
                const crimeResults = document.getElementById("crime-results");
                if (crimeResults) {
                    crimeResults.innerHTML = "<p>No recent crime results.</p>";
                }
                updateUI();
            }, 500);
        }

        function logout() {
            console.log("Logging out...");
            localStorage.removeItem("prohibitionPlayer");
            player = {
                name: "Player",
                rank: "Thug",
                cash: 0,
                xp: 0,
                influence: 0,
                energy: 10000,
                gold: 0,
                items: [],
                health: 100,
                lastEnergyUpdate: Date.now(),
                crimeAttempts: { "Speakeasy Heist": { timestamps: [] } },
                crimeResults: []
            };
            updateUI();
        }

        window.onload = function() {
            console.log("Window loaded, initializing game...");
            loadPlayer();
            updateUI();
        };
    </script>
</body>
</html>